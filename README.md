# NextBrain utils

NextBrain is a probabilistic atlas of the entire human brain derived
from histology images.

> Casamitjana, A., Mancini, M., Robinson, E., Peter, L. et al.
> A probabilistic histological atlas of the human brain for MRI segmentation.
> Nature (2025).
> https://doi.org/10.1038/s41586-025-09708-2

It can be used by an accompanying software to segment any brain scan into
more than 300 anatomical regions at sub-millimeter resolution.

> Puonti, O., Nolan, J., Dicamillo, R., Balbastre, Y., et al.
> Fast segmentation with the NextBrain histological atlas.
> bioRxiv (2025).
> https://doi.org/10.1101/2025.09.22.673638

The NextBrain subcortical labels follow the Allen Brain ontology.
The Allen Human Brain Atlas is a reference anatomical atlas of the human
brain drawn on a single specimen.

> Ding, S.-L., Royall, J.J., Sunkin, S.M., Ng, L. et al.
> Comprehensive cellular-resolution atlas of the adult human brain.
> The Journal of Comparative Neurology (2016).
> https://doi.org/10.1002/cne.24080

The tools provided in this package allow NextBrain label maps to be
converted to Allen Brain label maps. It also allows Allen Brain label
maps to be simplified by collapsing labels along levels of its ontology.

## Examples

#### Combine both NextBrain hemispheres into a single file

```shell
python -m nextbrain_utils combine \
    -l seg.left.nii.gz \
    -r seg.right.nii.gz \
    -o seg.both.nii.gz \
    -m sides.nii.gz
```

#### Convert NextBrain labels to Allen labels

```shell
python -m nextbrain_utils allen \
    -i seg.both.nii.gz \
    -o seg.allen.nii.gz
```

Note that this function approximately maps the Desikan-Killiany cortical
labels generated by Freesurfer/NextBrain to Allen's gyral labels. This
mapping is imperfect and cannot be totally trusted.

```shell
python -m nextbrain_utils allen \
    -i seg.both.nii.gz \
    -o seg.allen.nii.gz \
    -c dk
```

Alternatively, the Desikan-Killiany labels can be preserved, or
collapsed into coarsed "developmental" cortical regions.

```shell
python -m nextbrain_utils allen \
    -i seg.both.nii.gz \
    -o seg.allen.nii.gz \
    -c dev
```

#### Generate an Allen lookup table compatible with Freesurfer

```shell
python -m nextbrain_utils lut \
    -o AllenBrainLUT.txt \
    -l allen+dk
```

By default, this lookup table uses long names for each region. Acronyms
can be used instead.

```shell
python -m nextbrain_utils lut \
    -o AllenBrainLUT.txt \
    -l allen+dk \
    -a
```

#### Simplify an Allen segmentation map

```shell
python -m nextbrain_utils simplify \
    -i seg.allen.nii.gz \
    -o seg.simple.nii.gz \
    -l AMY ATA EXA Ca Pu NAC GP Cla BF THM SubTH HTH HIP
```

The list of labels to collapse can be long names, acronyms or IDs from
the Allen ontology.

Then Allen ontology can br browsed online:

* [Allen ontology, Developmental/Brodmann labels](https://atlas.brain-map.org/atlas?atlas=265297126#atlas=265297126&structure=10390)
* [Allen ontology, Gyral labels](https://atlas.brain-map.org/atlas?atlas=138322605#atlas=138322605&structure=10390)
